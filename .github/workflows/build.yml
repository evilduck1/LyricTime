name: Build & Release LyricTime

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Download FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $dest = "src-tauri/resources/bin/windows"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          $zip = "$env:RUNNER_TEMP\ffmpeg.zip"
          Invoke-WebRequest `
            -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" `
            -OutFile $zip

          $extract = "$env:RUNNER_TEMP\ffmpeg"
          if (Test-Path $extract) { Remove-Item -Recurse -Force $extract }
          Expand-Archive -Path $zip -DestinationPath $extract -Force

          $bin = Get-ChildItem -Path $extract -Recurse -Directory -Filter bin | Select-Object -First 1
          if (-not $bin) { throw "Could not find bin folder in extracted FFmpeg archive." }

          Copy-Item (Join-Path $bin.FullName "ffmpeg.exe")  -Destination $dest -Force
          Copy-Item (Join-Path $bin.FullName "ffprobe.exe") -Destination $dest -Force

          Write-Host "Bundled FFmpeg files:"
          Get-ChildItem -Path $dest

          $ff = Get-Item "$dest\ffmpeg.exe"
          if ($ff.Length -lt 5MB) { throw "ffmpeg.exe looks too small ($($ff.Length) bytes). Download likely failed." }

      - name: Verify FFmpeg present (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          dir src-tauri/resources/bin/windows
          if (!(Test-Path "src-tauri/resources/bin/windows/ffmpeg.exe"))  { throw "ffmpeg.exe missing" }
          if (!(Test-Path "src-tauri/resources/bin/windows/ffprobe.exe")) { throw "ffprobe.exe missing" }

      - name: Build & publish Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "LyricTime ${{ github.ref_name }}"
          releaseBody: "Automated build for ${{ github.ref_name }}"
          releaseDraft: false
          prerelease: false
